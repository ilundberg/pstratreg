<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 1 The big idea | pstratreg: An R package</title>
<meta name="author" content="Ian Lundberg and Soonhong Cho">
<meta name="description" content="Average causal effects are undefined when some outcomes do not exist. For example, consider the two people below who were eligible for a job training intervention. Person Wage with job training...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Chapter 1 The big idea | pstratreg: An R package">
<meta property="og:type" content="book">
<meta property="og:url" content="https://ilundberg.github.io/pstratreg/github_doc/index.html/the-big-idea.html">
<meta property="og:description" content="Average causal effects are undefined when some outcomes do not exist. For example, consider the two people below who were eligible for a job training intervention. Person Wage with job training...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 1 The big idea | pstratreg: An R package">
<meta name="twitter:description" content="Average causal effects are undefined when some outcomes do not exist. For example, consider the two people below who were eligible for a job training intervention. Person Wage with job training...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">pstratreg: An R package</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="active" href="the-big-idea.html"><span class="header-section-number">1</span> The big idea</a></li>
<li><a class="" href="package-functionality.html"><span class="header-section-number">2</span> Package functionality</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rstudio/bookdown-demo">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="the-big-idea" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> The big idea<a class="anchor" aria-label="anchor" href="#the-big-idea"><i class="fas fa-link"></i></a>
</h1>
<p>Average causal effects are undefined when some outcomes do not exist. For example, consider the two people below who were eligible for a job training intervention.</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="25%">
<col width="25%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="center">Person</th>
<th align="center">Wage with job training</th>
<th align="center">Wage without job training</th>
<th align="center">Causal effect</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Javier</td>
<td align="center">$30</td>
<td align="center">$20</td>
<td align="center">$30-$20=$10</td>
</tr>
<tr class="even">
<td align="center">William</td>
<td align="center">$26</td>
<td align="center">??</td>
<td align="center">$30-??=??</td>
</tr>
<tr class="odd">
<td align="center"><strong>Average</strong></td>
<td align="center"><strong>$28</strong></td>
<td align="center"><strong>??</strong></td>
<td align="center"><strong>??</strong></td>
</tr>
</tbody>
</table></div>
<p>A social scientist might study the average causal effect of the intervention on future hourly wages. But without job training, William would not be employed at all. His wage ?? does not exist. As a result, the average causal effect does not exist. Principal stratification is a method to estimate average causal effects in the subpopulation that excludes people like William, for whom the effect is undefined.</p>
<p>This page is a tutorial on the ideas behind principal stratification. See the next page for use of package functionality.</p>
<div id="defining-principal-strata" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Defining principal strata<a class="anchor" aria-label="anchor" href="#defining-principal-strata"><i class="fas fa-link"></i></a>
</h2>
<p>Let <span class="math inline">\(M_i\)</span> be a binary mediator (e.g., employment) that determines whether an outcome exists for unti <span class="math inline">\(i\)</span>. Let <span class="math inline">\(Y_i\)</span> be the outcome, where <span class="math inline">\(Y\)</span> is undefined when <span class="math inline">\(M = 0\)</span>. Let <span class="math inline">\(\{M_i^1,M_i^0\}\)</span> and <span class="math inline">\(\{Y_i^1,Y_i^0\}\)</span> be the potential values that the mediator and outcome would take for unit <span class="math inline">\(i\)</span> under job training and under no job training. The table above gave values for <span class="math inline">\(\{Y_i^1,Y_i^0\}\)</span>.</p>
<p>Define four <strong>principal strata</strong> of units by the effect that the intervention has on the mediator value</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th align="center">Stratum</th>
<th align="center">Math</th>
<th align="center">English</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><span class="math inline">\(S_i = \text{Always}\)</span></td>
<td align="center"><span class="math inline">\(M_i^1 = M_i^0 = 1\)</span></td>
<td align="center">Always employed, regardless of the intervention</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\(S_i = \text{Induced}\)</span></td>
<td align="center"><span class="math inline">\(M_i^1 &gt; M_i^0\)</span></td>
<td align="center">Induced into employment by the intervention</td>
</tr>
<tr class="odd">
<td align="center"><span class="math inline">\(S_i = \text{Blocked}\)</span></td>
<td align="center"><span class="math inline">\(M_i^1 &lt; M_i^0\)</span></td>
<td align="center">Blocked from employment by the intervention</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\(S_i = \text{Never}\)</span></td>
<td align="center"><span class="math inline">\(M_i^1 = M_i^0 = 0\)</span></td>
<td align="center">Never employed, regardless of the intervention</td>
</tr>
</tbody>
</table></div>
<p>In our example, Javier is a member of the always stratum and William is a member of the induced stratum.</p>
</div>
<div id="target-population-the-always-stratum" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Target population: The always stratum<a class="anchor" aria-label="anchor" href="#target-population-the-always-stratum"><i class="fas fa-link"></i></a>
</h2>
<p>The average causal effect <span class="math inline">\(E(Y^1 - Y^0)\)</span> is only defined in the “Always” stratum.</p>
<ul>
<li>in the induced stratum, <span class="math inline">\(Y^0\)</span> is undefined, so the effect is <span class="math inline">\(Y^1 - ??\)</span>
</li>
<li>in the blocked stratum, <span class="math inline">\(Y^1\)</span> is undefined, so the effect is <span class="math inline">\(?? - Y^0\)</span>
</li>
<li>in the never stratum, both are undefined, so the effect is <span class="math inline">\(?? - ??\)</span>
</li>
</ul>
<p>Our causal estimand is therefore the average causal effect in the always stratum.</p>
<p><span class="math display">\[E(Y^1 - Y^0 \mid S = \text{Always})\]</span></p>
</div>
<div id="fundamental-problem-strata-are-latent" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Fundamental problem: Strata are latent<a class="anchor" aria-label="anchor" href="#fundamental-problem-strata-are-latent"><i class="fas fa-link"></i></a>
</h2>
<p>Suppose William received job training. We would observe his $26 wage. We would not know that he would not have been employed without job training. If William received job training, then in the observed data we would know that he was either in the always stratum or the induced stratum.</p>
<p>What can be observed is the treatment value <span class="math inline">\(D_i\)</span> and the mediator value <span class="math inline">\(M_i\)</span>. Each combination of these values is a mixture of two principal strata.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"></th>
<th align="center"><span class="math inline">\(D_i = 1\)</span></th>
<th align="center"><span class="math inline">\(D_i = 0\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><span class="math inline">\(M_i = 1\)</span></td>
<td align="center">Always and Induced</td>
<td align="center">Always and Blocked</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\(M_i = 0\)</span></td>
<td align="center">Never and Blocked</td>
<td align="center">Never and Induced</td>
</tr>
</tbody>
</table></div>
</div>
<div id="solution-step-1-make-an-assumption" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Solution step 1: Make an assumption<a class="anchor" aria-label="anchor" href="#solution-step-1-make-an-assumption"><i class="fas fa-link"></i></a>
</h2>
<p>Assumptions can simplify the problem, and can be plausible in some settings. We focus on two versions of one assumption.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center">Assumption</th>
<th align="center">Math</th>
<th align="center">English</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Positive monotonicity</td>
<td align="center"><span class="math inline">\(M_i^1 \geq M_i^0\)</span></td>
<td align="center">No one is blocked</td>
</tr>
<tr class="even">
<td align="center">Negative monotonicity</td>
<td align="center"><span class="math inline">\(M_i^1\leq M_i^0\)</span></td>
<td align="center">No one is induced</td>
</tr>
</tbody>
</table></div>
<p>In our example, the positive monotonicity assumption may be credible: job training is unlikely to block anyone from employment. In other settings, the negative monotonicity assumption is credible. If the treatment were having a criminal record on one’s resume, that treatment might block employment but would be unlikely to induce employment.</p>
<p>Under positive monotonicity, some latent strata become observable.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"></th>
<th align="center"><span class="math inline">\(D_i = 1\)</span></th>
<th align="center"><span class="math inline">\(D_i = 0\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><span class="math inline">\(M_i = 1\)</span></td>
<td align="center">Always and Induced</td>
<td align="center">Always</td>
</tr>
<tr class="even">
<td align="center"><span class="math inline">\(M_i = 0\)</span></td>
<td align="center">Never</td>
<td align="center">Never and Induced</td>
</tr>
</tbody>
</table></div>
<p>For example, suppose that Javier was assigned to no job training, and we observed that he was employed. Under positive monotonicity, we would know that Javier was in the always stratum because he was employed without job training, and thus surely would have been employed with job training.</p>
</div>
<div id="solution-step-2-bound-the-average-effect-in-the-always-stratum" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> Solution step 2: Bound the average effect in the always stratum<a class="anchor" aria-label="anchor" href="#solution-step-2-bound-the-average-effect-in-the-always-stratum"><i class="fas fa-link"></i></a>
</h2>
<p>Suppose we assume positive monotonicity, and we observe data where four people have been randomized to each treatment condition.</p>
<p>In the no-job-training condition, we observe the following four people</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center">Person</th>
<th align="center">Treatment</th>
<th align="center">Wage</th>
<th align="center">Stratum</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Jamal</td>
<td align="center">No job training</td>
<td align="center">$20</td>
<td align="center">Always</td>
</tr>
<tr class="even">
<td align="center">Sandra</td>
<td align="center">No job training</td>
<td align="center">$16</td>
<td align="center">Always</td>
</tr>
<tr class="odd">
<td align="center">Oscar</td>
<td align="center">No job training</td>
<td align="center">??</td>
<td align="center">Never or Induced</td>
</tr>
<tr class="even">
<td align="center">Nancy</td>
<td align="center">No job training</td>
<td align="center">??</td>
<td align="center">Never or Induced</td>
</tr>
</tbody>
</table></div>
<p>The stratum column is sometimes known by assumption: Jamal and Sandra were employed despite no job training, so they surely would have been employed in a counterfactual world with job training (by positive monotonicity). Oscar and Nancy might or might not have been employed in a counterfactual world where they received job training.</p>
<p>Four people were randomized to the treatment: job training</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center">Person</th>
<th align="center">Treatment</th>
<th align="center">Wage</th>
<th align="center">Stratum</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Nia</td>
<td align="center">Job training</td>
<td align="center">$40</td>
<td align="center">Always or Induced</td>
</tr>
<tr class="even">
<td align="center">Steven</td>
<td align="center">Job training</td>
<td align="center">$32</td>
<td align="center">Always or Induced</td>
</tr>
<tr class="odd">
<td align="center">Maya</td>
<td align="center">Job training</td>
<td align="center">$29</td>
<td align="center">Always or Induced</td>
</tr>
<tr class="even">
<td align="center">Hugo</td>
<td align="center">Job training</td>
<td align="center">$25</td>
<td align="center">Always or Induced</td>
</tr>
</tbody>
</table></div>
<p>The stratum column for the four treated people is always unknown, because under positive monotonicity they might or might not have been employed despite no job training.</p>
<p>By comparing the frequency of ?? in the tables, we can estimate that job training reduces employment by 50 percentage points. This tells us the size of the induced stratum.</p>
<p><span class="math display">\[\hat{P}(S = \text{Induced}) = 0.5\]</span></p>
<p>Because all those receiving job training were employed, our data also suggest that the never-employed stratum is empty.</p>
<p><span class="math display">\[\hat{P}(S = \text{Never}) = 0\]</span></p>
<p>Thus, in our example we estimate that 50% of people are always employed and 50% would be induced into employment if exposed to job training. Thus half of {Nia, Steven, Maya, Hugo} are always-employed.</p>
<p>But which half? This is impossible to know. We therefore <strong>bound</strong> the expected outcome under treatment.</p>
<ul>
<li>for an <em>upper bound</em>, assume the highest-valued half of the treated units are the always-employed ones
<ul>
<li>Nia and Steven are always employed</li>
<li>Maya and Hugo are induced</li>
<li><span class="math inline">\(\hat{E}_\text{Upper}(Y^1\mid S = \text{Always}) = \frac{32+40}{2} = \$36\)</span></li>
</ul>
</li>
<li>for a <em>lower bound</em>, assume the lowest-valued half of the treated units are the always-employed ones
<ul>
<li>Nia and Steven are induced</li>
<li>Maya and Hugo are always employed</li>
<li><span class="math inline">\(\hat{E}_\text{Lower}(Y^1\mid S = \text{Always}) = \frac{25+29}{2} = \$27\)</span></li>
</ul>
</li>
</ul>
<p>Because under positive monotonicity all untreated individuals must be always-employed, we point estimate the outcome under control</p>
<p><span class="math display">\[\hat{E}(Y^0\mid S = \text{Always}) = \$18\]</span></p>
<p>The difference tells us that the average causal effect of job training on the wages of the always employed is between $27 - $18 = $9 and $36 - $18 = $18.</p>
</div>
<div id="regression-bounds" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Regression bounds<a class="anchor" aria-label="anchor" href="#regression-bounds"><i class="fas fa-link"></i></a>
</h2>
<p>In observational causal inference, we may adjust for a vector <span class="math inline">\(\vec{X}\)</span> of confounding variables.</p>
<ul>
<li>when <span class="math inline">\(\vec{X}\)</span> can take only a few discrete values, one can carry out principal stratification as above within each stratum of <span class="math inline">\(\vec{X}\)</span>
</li>
<li>when <span class="math inline">\(\vec{X}\)</span> can take many values, it is possible that each vector value <span class="math inline">\(\vec{X}_i\)</span> is unique</li>
</ul>
<p>In the latter setting, we need model-based principal stratification.</p>
<ol style="list-style-type: decimal">
<li>Model the mediator
<ul>
<li>Fit a model for the mediator <span class="math inline">\(M\)</span>
</li>
<li>Estimate the probability of each stratum for each unit</li>
</ul>
</li>
<li>Model the outcome
<ul>
<li>Fit a model for the outcome <span class="math inline">\(Y\mid A = 1, M = 1, \vec{X}\)</span>
<ul>
<li>Example: Model the distribution of wages for employed job training recipients</li>
</ul>
</li>
<li>Fit a model for the outcome <span class="math inline">\(Y\mid A = 0, M = 1, \vec{X}\)</span>
<ul>
<li>Example: Model the distribution of wages for employed job training recipients</li>
</ul>
</li>
<li>Bound by assuming that the proportion induced (from 1) is the upper or lower portion conditional on covariates</li>
</ul>
</li>
</ol>
<div id="upper-bound-left---right" class="section level3" number="1.6.1">
<h3>
<span class="header-section-number">1.6.1</span> Upper bound: Left - Right<a class="anchor" aria-label="anchor" href="#upper-bound-left---right"><i class="fas fa-link"></i></a>
</h3>
<p><img src="assets/teach_jobtrain_upper.png" style="width:40.0%"><img src="assets/teach_jobtrain_control.png" style="width:40.0%"></p>
</div>
<div id="lower-bound-left---right" class="section level3" number="1.6.2">
<h3>
<span class="header-section-number">1.6.2</span> Lower bound: Left - Right<a class="anchor" aria-label="anchor" href="#lower-bound-left---right"><i class="fas fa-link"></i></a>
</h3>
<p><img src="assets/teach_jobtrain_lower.png" style="width:40.0%"><img src="assets/teach_jobtrain_control.png" style="width:40.0%"></p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html">Welcome!</a></div>
<div class="next"><a href="package-functionality.html"><span class="header-section-number">2</span> Package functionality</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-big-idea"><span class="header-section-number">1</span> The big idea</a></li>
<li><a class="nav-link" href="#defining-principal-strata"><span class="header-section-number">1.1</span> Defining principal strata</a></li>
<li><a class="nav-link" href="#target-population-the-always-stratum"><span class="header-section-number">1.2</span> Target population: The always stratum</a></li>
<li><a class="nav-link" href="#fundamental-problem-strata-are-latent"><span class="header-section-number">1.3</span> Fundamental problem: Strata are latent</a></li>
<li><a class="nav-link" href="#solution-step-1-make-an-assumption"><span class="header-section-number">1.4</span> Solution step 1: Make an assumption</a></li>
<li><a class="nav-link" href="#solution-step-2-bound-the-average-effect-in-the-always-stratum"><span class="header-section-number">1.5</span> Solution step 2: Bound the average effect in the always stratum</a></li>
<li>
<a class="nav-link" href="#regression-bounds"><span class="header-section-number">1.6</span> Regression bounds</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#upper-bound-left---right"><span class="header-section-number">1.6.1</span> Upper bound: Left - Right</a></li>
<li><a class="nav-link" href="#lower-bound-left---right"><span class="header-section-number">1.6.2</span> Lower bound: Left - Right</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rstudio/bookdown-demo/blob/master/01_big_idea.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rstudio/bookdown-demo/edit/master/01_big_idea.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>pstratreg: An R package</strong>" was written by Ian Lundberg and Soonhong Cho. It was last built on 2023-10-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
